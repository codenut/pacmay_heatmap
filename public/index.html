<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pacman - Mayweather Heat Map</title>
  <style>
     html, body, #map-canvas {
       height: 100%;
       margin: 0px;
       padding: 0px
     }
     #panel {
       position: absolute;
       top: 5px;
       left: 50%;
       margin-left: -180px;
       z-index: 5;
       background-color: #fff;
       padding: 5px;
       border: 1px solid #999;
     }
  </style>
  <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="./js/jquery.eventsource.js"></script>
  <script src="//maps.googleapis.com/maps/api/js?v=3.exp&libraries=visualization"></script>

  <script>
    var taxiData = [], heatmap, map, pointArray;

    var init = function() {
      var mapOptions = {
        zoom: 2,
        center: new google.maps.LatLng(37.774546, -122.433523),
        mapTypeId: google.maps.MapTypeId.ROADMAP
      } 
      
      map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
      
      pointArray = new google.maps.MVCArray(taxiData);
      
      heatmap = new google.maps.visualization.HeatmapLayer({
        data: pointArray,
      });

      heatmap.setMap(map);

    }

    /*$.eventsource({
      label: "json-event-source",
      url: "http://localhost:5000/new_tweets",

      open: function() {
        console.log("Opened event source"); 
      },

      message: function(data) {
        console.log("Data received: " + data); 
      }
    });*/
    var sse = new EventSource("http://localhost:5000/new_tweets");

    sse.onmessage = function(event) {
      if(event.data) {
        console.log(event.data);
        var json = $.parseJSON(event.data); 
        console.log(json);
        if(json.coordinates) {
          pointArray.push(new google.maps.LatLng(json.coordinates[1], json.coordinates[0]));
        }
      }
    }

    var getTaxiData = function() {
      /*$.getJSON("http://localhost:5000/tweets", function(data) {
        for(var key in data) {
          var coordinates = data[key]["coordinates"]; 
          taxiData.push(new google.maps.LatLng(coordinates[1], coordinates[0]));
        }

      }); */
    }

    getTaxiData();
    google.maps.event.addDomListener(window, 'load', init);
  </script>
</head>

<body>
  <div id="panel"></div>
  <div id="map-canvas"></div>
</body>
</html>
